# gensyn-in-docker

В этом репозитории вы найдете файлы для самостоятельной сборки Docker-образа GPU-
воркера для сети Gensyn. Команда проекта не предоставила официального образа, 
поэтому я создал этот репозиторий, чтобы сэкономить время и усилия других 
пользователей, предоставив готовый образ с несколькими полезными встроенными 
инструментами.


# Используемые инстурменты

В качестве базового Docker-образа используется расширенная пропатченная версия 
Ubuntu от Phusion phusion/baseimage-docker, которая поддерживает запуск нескольких 
рабочих процессов внутри контейнера. Помимо воркера Gensyn, в образ включены 
следующие инструменты:

* Jinja - для создания шаблонных конфиг-файлов;
* VPN Tailscale — для безопасного сетевого подключения;
* nvitop-exporter — инструмент для генерации метрик о состоянии GPU.

# Загрузка

Самый простой способ получить Docker-образ gensyn-in-docker — скачать его из 
репозитория с помощью команды:

```
docker pull mtchuikov/gensyn-in-docker
```


Вы также можете собрать Docker-образ самостоятельно. Перед сборкой убедитесь,
что на вашей системе установлены все необходимые пакеты:

```
sudo apt update

sudo apt install -y \
    gcc \
    python3-dev \
    python3-pip \
    python3.12-venv

command -v task >/dev/null 2>&1 || \
    sh -c "$(curl --location https://taskfile.dev/install.sh)" \
    -- -d -b ~/.local/bin
```

Затем скачайте репозиторий и выполните сборку:


```
git clone https://github.com/mtchuikov/gensyn-in-docker
cd ./gensyn-in-docker
task build-image
```

После успешного завершения сборки появится готовый к использованию Docker образ 
`gensyn-in-docker:latest`.

# Конфигурация

Приложения в контейнере можно настроить с помощью переменных окружения. Все 
переменные находятся в папке env, где хранятся файлы, названные по именам 
соответствующих приложений. Эти файлы содержат переменные окружения для их 
конфигурации.

Переменные окружения можно переопределить при запуске контейнера с помощью флага 
`-e`. Например:

```
docker run -e SSH_PORT=4215 mtchuikov/gensyn-in-docker
```

В данном случае переменная SSH_PORT изменит порт для подключения к серверу через 
SSH. Значения, заданные через флаг `-e`, имеют приоритет над значениями из 
файлов.

| Приложение | Переменные окружения |
| --- | --- |
nvitop-exporter | env/nvitop-exporter.env
ssh | env/ssh.env
swarm | env/swarm.env
tailscale | env/tailscale.env

# Управление запуском приложений

Чтобы включить или отключить запуск приложения, измените значение переменной 
вида `APPNAME_ENABLE`. Например, чтобы включить запуск VPN Tailscale следует 
установить флаг `TS_ENABLE`.

| Приложение | Запуск по умолчанию |
| --- | --- |
nvitop-exporter | Нет
ssh | Нет
swarm | Да
tailscale | Нет

# Запуск

Перед запуском убедитесь, что на вашей системе установлен NVIDIA Container 
Toolkit, который позволяет Docker контейнерам использовать ресурсы GPU:
https://docs.nvidia.com/datacenter/cloud-native/container-toolkit

Для запуска воркера Gensyn при старте контейнера необходимо передать в него
закодированное в base64 содержимое файлов `userApiKey.json` и `userData.json`.
Данные файлы генерируются по пути `rl-swarm/modal-login/temp-data` при входе в
Gensyn через веб-интерфейс. 

Для кодирования содержимого в base64 необходимо использовать команду: 
`cat FILE_NAME | base64 -w 0`. Полученный результат следует передать в окружение
контейнера через переменные `SWARM_API_KEY` и `SWARM_USER_DATA`.

При необходимости изменить параметры воркера - количество шагов в раунде, объем
используемой видеопамяти и т.п. - это можно сделать также при помощи переменных
окружения, представленных в файле `env/swarm.env`.

Финальная команда для запуска может выглядеть следующим образом:
```
docker run -d \
    --gpus='"device=0"' \
    -p 57517 \
    -p 43212/udp \
    -p 51888/udp \
    -p 38331 \
    -e SSH_ENABLE=true \
    -e TS_ENABLE=true \
    -e TS_AUTHKEY=YOUR_TS_AUTHKEY \
    -e SWARM_API_KEY=YOUR_SWARM_API_KEY_IN_BASE64 \
    -e SWARM_USER_DATA=YOUR_SWARM_USER_DATA_IN_BASE64 \
    mtchuikov/gensyn-in-docker
```
